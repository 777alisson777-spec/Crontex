{# templates/catalog/produto_form.html #}
{% extends "base_app.html" %}
{% load static %}
{% block title %}{{ form.instance.pk|yesno:"Editar produto,Novo produto" }}{% endblock %}

{% block content %}
<div class="container catalog-scope">
  <div class="card">
    <div class="card-title">{{ form.instance.pk|yesno:"Editar produto,Novo produto" }}</div>

    {# resumo dos erros do form #}
    {% if form.errors %}
    <div class="alert danger" role="alert">
      <strong>Preencha os campos obrigatórios:</strong>
      <ul>
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ field.label }} — {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <nav class="tabs" role="tablist" aria-label="Abas do produto">
      <button type="button" class="tab is-active" role="tab" aria-selected="true" tabindex="0" data-tab="pedido">Pedido</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="os">OS</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="bling">Bling</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="manufatura">Manufatura</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="material">Material</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="grade">Grade</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="av-oficina">Aviamentos Oficina</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="av-acab">Aviamentos Acabamento</button>
    </nav>

    <form method="post" id="produto-form" class="form" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form.non_field_errors }}
      {{ form.form_uid }}

      <div class="tab-panels" id="produto-tab-panels">
        <!-- PEDIDO -->
        <section class="tab-panel is-active" role="tabpanel" data-tab="pedido">
          <div class="grid">
            <div>
              <label for="id_pedido_requisitante">Requisitante:</label>
              <div data-combo data-role="REQUISITANTE"
                   data-txt="#id_pedido_requisitante"
                   data-hid="#id_pedido_requisitante_id"></div>
              <input type="hidden" name="pedido_requisitante_id" id="id_pedido_requisitante_id" class="input">
              <input type="text" name="pedido_requisitante" maxlength="150" class="input" id="id_pedido_requisitante" autocomplete="off">
            </div>

            <div>
              <label for="id_pedido_cliente">Cliente:</label>
              <div data-combo data-role="CLIENTE"
                   data-txt="#id_pedido_cliente"
                   data-hid="#id_pedido_cliente_id"></div>
              <input type="hidden" name="pedido_cliente_id" id="id_pedido_cliente_id" class="input">
              <input type="text" name="pedido_cliente" maxlength="150" class="input" id="id_pedido_cliente" autocomplete="off">
            </div>

            <div>
              <label for="id_pedido_status">Status:</label>
              <input type="text" name="pedido_status" maxlength="80" class="input" id="id_pedido_status" autocomplete="off">
            </div>
          </div>

          <div class="mt-3">
            <a class="dynamic-add" data-add="#pedido-extra" data-template="#tpl-pedido-extra">+ inserir campo</a>
            <div id="pedido-extra" class="dynamic-list"></div>
            <template id="tpl-pedido-extra">
              <div class="dynamic-row" data-row>
                <input type="text" name="pedido_extra_key___idx__" placeholder="Nome do campo" class="input">
                <input type="text" name="pedido_extra_val___idx__" placeholder="Valor" class="input">
              </div>
            </template>
          </div>
        </section>

        <!-- OS -->
        <section class="tab-panel" role="tabpanel" data-tab="os">
          <div class="grid">
            <div>
              <label for="id_os_estilo">Estilo:</label>
              <div class="combo" data-combo data-role="ESTILISTA">
                {{ form.os_estilo_id }}
                {{ form.os_estilo }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
              {% if form.os_estilo.errors %}<div class="field-error">{{ form.os_estilo.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_os_arte">Arte:</label>
              <div class="combo" data-combo data-role="ARTE">
                {{ form.os_arte_id }}
                {{ form.os_arte }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
              {% if form.os_arte.errors %}<div class="field-error">{{ form.os_arte.errors.0 }}</div>{% endif %}
            </div>

            <!-- Uploads p/ IA -->
            <div class="field">
              <label class="label">Desenho técnico (PNG/JPG/SVG/PDF)</label>
              {{ form.os_desenho_tecnico }}
              {% if form.os_desenho_tecnico.errors %}<div class="field-error">{{ form.os_desenho_tecnico.errors.0 }}</div>{% endif %}
            </div>

            <div class="field">
              <label class="label">Artes / estampa (PNG/JPG/SVG)</label>
              {{ form.os_artes }}
              {% if form.os_artes.errors %}<div class="field-error">{{ form.os_artes.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_os_modelagem">Modelagem:</label>
              <div class="combo" data-combo data-role="MODELAGEM">
                {{ form.os_modelagem_id }}
                {{ form.os_modelagem }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
              {% if form.os_modelagem.errors %}<div class="field-error">{{ form.os_modelagem.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_os_pilotagem">Pilotagem:</label>
              <div class="combo" data-combo data-role="PILOTAGEM">
                {{ form.os_pilotagem_id }}
                {{ form.os_pilotagem }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
              {% if form.os_pilotagem.errors %}<div class="field-error">{{ form.os_pilotagem.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_os_encaixe">Encaixe:</label>
              <div class="combo" data-combo data-role="ENCAIXE">
                {{ form.os_encaixe_id }}
                {{ form.os_encaixe }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
              {% if form.os_encaixe.errors %}<div class="field-error">{{ form.os_encaixe.errors.0 }}</div>{% endif %}
            </div>
          </div>
        </section>

        <!-- BLING -->
        <section class="tab-panel" role="tabpanel" data-tab="bling" hidden>
          <div class="alert info">EAN-13 em tempo real via <b>Referência</b> + <b>Base</b> + códigos gerados pelos chips da Grade.</div>
          <div class="grid mb-4">
            <div>
              <label class="label" for="ean-ref">Referência (4 dígitos)</label>
              <input id="ean-ref" type="text" maxlength="4" class="input" placeholder="0000" autocomplete="off">
            </div>
            <div>
              <label class="label" for="ean-base">Base (4 dígitos)</label>
              <input id="ean-base" type="text" maxlength="4" class="input" placeholder="0000" autocomplete="off">
            </div>
          </div>

          <div class="grid">
            <div>{{ form.external_id.label_tag }} {{ form.external_id }}{% if form.external_id.errors %}<div class="field-error">{{ form.external_id.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.sku.label_tag }} {{ form.sku }}{% if form.sku.errors %}<div class="field-error">{{ form.sku.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.name.label_tag }} {{ form.name }}{% if form.name.errors %}<div class="field-error">{{ form.name.errors.0 }}</div>{% endif %}</div>

            <div>{{ form.origin.label_tag }} {{ form.origin }}{% if form.origin.errors %}<div class="field-error">{{ form.origin.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.status.label_tag }} {{ form.status }}{% if form.status.errors %}<div class="field-error">{{ form.status.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.is_active.label_tag }} {{ form.is_active }}{% if form.is_active.errors %}<div class="field-error">{{ form.is_active.errors.0 }}</div>{% endif %}</div>

            <div>{{ form.price.label_tag }} {{ form.price }}{% if form.price.errors %}<div class="field-error">{{ form.price.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.cost_price.label_tag }} {{ form.cost_price }}{% if form.cost_price.errors %}<div class="field-error">{{ form.cost_price.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.purchase_price.label_tag }} {{ form.purchase_price }}{% if form.purchase_price.errors %}<div class="field-error">{{ form.purchase_price.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.stock_qty.label_tag }} {{ form.stock_qty }}{% if form.stock_qty.errors %}<div class="field-error">{{ form.stock_qty.errors.0 }}</div>{% endif %}</div>

            <div>{{ form.ncm.label_tag }} {{ form.ncm }}{% if form.ncm.errors %}<div class="field-error">{{ form.ncm.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.cest.label_tag }} {{ form.cest }}{% if form.cest.errors %}<div class="field-error">{{ form.cest.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.ipi_fixed.label_tag }} {{ form.ipi_fixed }}{% if form.ipi_fixed.errors %}<div class="field-error">{{ form.ipi_fixed.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.icms_st_base_retencao.label_tag }} {{ form.icms_st_base_retencao }}{% if form.icms_st_base_retencao.errors %}<div class="field-error">{{ form.icms_st_base_retencao.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.icms_st_valor_retencao.label_tag }} {{ form.icms_st_valor_retencao }}{% if form.icms_st_valor_retencao.errors %}<div class="field-error">{{ form.icms_st_valor_retencao.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.icms_proprio_substituto.label_tag }} {{ form.icms_proprio_substituto }}{% if form.icms_proprio_substituto.errors %}<div class="field-error">{{ form.icms_proprio_substituto.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.gtin.label_tag }} {{ form.gtin }}{% if form.gtin.errors %}<div class="field-error">{{ form.gtin.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.fci_number.label_tag }} {{ form.fci_number }}{% if form.fci_number.errors %}<div class="field-error">{{ form.fci_number.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.clone_from_parent.label_tag }} {{ form.clone_from_parent }}{% if form.clone_from_parent.errors %}<div class="field-error">{{ form.clone_from_parent.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.free_shipping.label_tag }} {{ form.free_shipping }}{% if form.free_shipping.errors %}<div class="field-error">{{ form.free_shipping.errors.0 }}</div>{% endif %}</div>

            <div>{{ form.width_cm.label_tag }} {{ form.width_cm }}{% if form.width_cm.errors %}<div class="field-error">{{ form.width_cm.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.height_cm.label_tag }} {{ form.height_cm }}{% if form.height_cm.errors %}<div class="field-error">{{ form.height_cm.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.length_cm.label_tag }} {{ form.length_cm }}{% if form.length_cm.errors %}<div class="field-error">{{ form.length_cm.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.weight_net.label_tag }} {{ form.weight_net }}{% if form.weight_net.errors %}<div class="field-error">{{ form.weight_net.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.weight_gross.label_tag }} {{ form.weight_gross }}{% if form.weight_gross.errors %}<div class="field-error">{{ form.weight_gross.errors.0 }}</div>{% endif %}</div>

            <div>{{ form.product_category.label_tag }} {{ form.product_category }}{% if form.product_category.errors %}<div class="field-error">{{ form.product_category.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.department.label_tag }} {{ form.department }}{% if form.department.errors %}<div class="field-error">{{ form.department.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.brand.label_tag }} {{ form.brand }}{% if form.brand.errors %}<div class="field-error">{{ form.brand.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.unit_of_measure.label_tag }} {{ form.unit_of_measure }}{% if form.unit_of_measure.errors %}<div class="field-error">{{ form.unit_of_measure.errors.0 }}</div>{% endif %}</div>

            <div style="display:none">{{ form.bling_extra }}</div>
          </div>

          <div class="mt-3">
            <a class="dynamic-add" data-add="#bling-extra" data-template="#tpl-bling-extra">+ inserir campo</a>
            <div id="bling-extra" class="dynamic-list"></div>
            <template id="tpl-bling-extra">
              <div class="dynamic-row" data-row>
                <input type="text" name="bling_extra_key___idx__" placeholder="Nome do campo" class="input">
                <input type="text" name="bling_extra_val___idx__" placeholder="Valor" class="input">
              </div>
            </template>
          </div>
        </section>

        <!-- MANUFATURA -->
        <section class="tab-panel" role="tabpanel" data-tab="manufatura">
          <div class="grid">
            <div>
              <label for="id_m_corte">Corte:</label>
              <div data-combo data-role="CORTE"
                   data-txt="#id_m_corte"
                   data-hid="#id_m_corte_id"></div>
              <input type="hidden" name="m_corte_id" id="id_m_corte_id" class="input">
              {{ form.m_corte }}
              {% if form.m_corte.errors %}<div class="field-error">{{ form.m_corte.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_m_costura">Costura:</label>
              <div data-combo data-role="COSTURA"
                   data-txt="#id_m_costura"
                   data-hid="#id_m_costura_id"></div>
              <input type="hidden" name="m_costura_id" id="id_m_costura_id" class="input">
              {{ form.m_costura }}
              {% if form.m_costura.errors %}<div class="field-error">{{ form.m_costura.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_m_estamparia">Estamparia:</label>
              <div data-combo data-role="ESTAMPARIA"
                   data-txt="#id_m_estamparia"
                   data-hid="#id_m_estamparia_id"></div>
              <input type="hidden" name="m_estamparia_id" id="id_m_estamparia_id" class="input">
              {{ form.m_estamparia }}
              {% if form.m_estamparia.errors %}<div class="field-error">{{ form.m_estamparia.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_m_bordado">Bordado:</label>
              <div data-combo data-role="BORDADO"
                   data-txt="#id_m_bordado"
                   data-hid="#id_m_bordado_id"></div>
              <input type="hidden" name="m_bordado_id" id="id_m_bordado_id" class="input">
              {{ form.m_bordado }}
              {% if form.m_bordado.errors %}<div class="field-error">{{ form.m_bordado.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_m_lavanderia">Lavanderia:</label>
              <div data-combo data-role="LAVANDERIA"
                   data-txt="#id_m_lavanderia"
                   data-hid="#id_m_lavanderia_id"></div>
              <input type="hidden" name="m_lavanderia_id" id="id_m_lavanderia_id" class="input">
              {{ form.m_lavanderia }}
              {% if form.m_lavanderia.errors %}<div class="field-error">{{ form.m_lavanderia.errors.0 }}</div>{% endif %}
            </div>

            <div>
              <label for="id_m_acabamento">Acabamento:</label>
              <div data-combo data-role="ACABAMENTO"
                   data-txt="#id_m_acabamento"
                   data-hid="#id_m_acabamento_id"></div>
              <input type="hidden" name="m_acabamento_id" id="id_m_acabamento_id" class="input">
              {{ form.m_acabamento }}
              {% if form.m_acabamento.errors %}<div class="field-error">{{ form.m_acabamento.errors.0 }}</div>{% endif %}
            </div>
          </div>

          <div class="mt-3">
            <a class="dynamic-add" data-add="#manuf-extra" data-template="#tpl-manuf-extra">+ inserir campo</a>
            <div id="manuf-extra" class="dynamic-list"></div>
            <template id="tpl-manuf-extra">
              <div class="dynamic-row" data-row>
                <input type="text" name="manuf_extra_key___idx__" placeholder="Nome do campo" class="input">
                <input type="text" name="manuf_extra_val___idx__" placeholder="Valor" class="input">
              </div>
            </template>
          </div>
        </section>

        <!-- MATERIAL -->
        <section class="tab-panel" role="tabpanel" data-tab="material" hidden>
          <div class="grid">
            <div>{{ form.os_estilo.label_tag }} {{ form.os_estilo }}{% if form.os_estilo.errors %}<div class="field-error">{{ form.os_estilo.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.os_arte.label_tag }} {{ form.os_arte }}{% if form.os_arte.errors %}<div class="field-error">{{ form.os_arte.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.os_modelagem.label_tag }} {{ form.os_modelagem }}{% if form.os_modelagem.errors %}<div class="field-error">{{ form.os_modelagem.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.os_pilotagem.label_tag }} {{ form.os_pilotagem }}{% if form.os_pilotagem.errors %}<div class="field-error">{{ form.os_pilotagem.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.os_encaixe.label_tag }} {{ form.os_encaixe }}{% if form.os_encaixe.errors %}<div class="field-error">{{ form.os_encaixe.errors.0 }}</div>{% endif %}</div>
          </div>
        </section>

        <!-- GRADE -->
        <section class="tab-panel" role="tabpanel" data-tab="grade" hidden>
          <div class="alert info" role="note">
            Adicione variações e defina se cada atributo será <b>linha</b> ou <b>coluna</b>. Use TAB/ENTER/vírgula para criar mini-chips.
          </div>
          {% include "catalog/_grades_variations.html" %}
        </section>

        <!-- AVIAMENTOS OFICINA -->
        <section class="tab-panel" role="tabpanel" data-tab="av-oficina" hidden>
          <div class="grid">
            <div class="col-span-2">
              {{ form.av_oficina_linha_1.label_tag }} {{ form.av_oficina_linha_1 }}
              {% if form.av_oficina_linha_1.errors %}<div class="field-error">{{ form.av_oficina_linha_1.errors.0 }}</div>{% endif %}
            </div>
          </div>
          <div class="mt-3">
            <a class="dynamic-add" data-add="#av-oficina-list" data-template="#tpl-av-oficina-row">+ inserir campo</a>
            <div id="av-oficina-list" class="dynamic-list"></div>
            <template id="tpl-av-oficina-row">
              <div class="dynamic-row" data-row>
                <input type="text" name="av_oficina_item___idx__" placeholder="Item (ex.: Linha 120 Tex)" class="input">
                <input type="text" name="av_oficina_qtd___idx__" placeholder="Qtd/Obs" class="input">
              </div>
            </template>
          </div>
        </section>

        <!-- AVIAMENTOS ACABAMENTO -->
        <section class="tab-panel" role="tabpanel" data-tab="av-acab" hidden>
          <div class="grid">
            <div>{{ form.avacab_sacola.label_tag }} {{ form.avacab_sacola }}{% if form.avacab_sacola.errors %}<div class="field-error">{{ form.avacab_sacola.errors.0 }}</div>{% endif %}</div>
            <div>{{ form.avacab_tag.label_tag }} {{ form.avacab_tag }}{% if form.avacab_tag.errors %}<div class="field-error">{{ form.avacab_tag.errors.0 }}</div>{% endif %}</div>
          </div>
        </section>
      </div>

      <div class="form-actions">
        <button class="btn" type="submit">Salvar</button>
        <a class="btn secondary" href="{% url 'catalog:produto_list' %}">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<link rel="stylesheet" href="{% static 'crontex/css/catalog.css' %}">
<link rel="stylesheet" href="{% static 'crontex/css/grades_variations.css' %}">
<script src="{% static 'crontex/js/produto_form_full.js' %}"></script>
<script src="{% static 'crontex/js/people_optionlist.js' %}?v=3"></script>
{% endblock %}
