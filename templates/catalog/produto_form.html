{# templates/catalog/produto_form.html #}
{% extends "base_app.html" %}
{% load static %}
{% block title %}{{ form.instance.pk|yesno:"Editar produto,Novo produto" }}{% endblock %}

{% block content %}
<div class="container catalog-scope">
  <div class="card">
    <div class="card-title">{{ form.instance.pk|yesno:"Editar produto,Novo produto" }}</div>

    {% if form.errors %}
      <div class="alert error" role="alert">Revise os campos destacados.</div>
    {% endif %}

    <nav class="tabs" role="tablist" aria-label="Abas do produto">
      <button type="button" class="tab is-active" role="tab" aria-selected="true" tabindex="0" data-tab="pedido">Pedido</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="os">OS</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="bling">Bling</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="manufatura">Manufatura</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="material">Material</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="grade">Grade</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="av-oficina">Aviamentos Oficina</button>
      <button type="button" class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="av-acab">Aviamentos Acabamento</button>
    </nav>

    <form method="post" id="produto-form" class="form">
      {% csrf_token %}
      {{ form.non_field_errors }}
      {{ form.form_uid }}

      <div class="tab-panels" id="produto-tab-panels">
        <!-- PEDIDO -->
        <section class="tab-panel is-active" role="tabpanel" data-tab="pedido">
          <div class="grid">
            <!-- Requisitante (pessoa) -->
            <div>
              <label for="id_pedido_requisitante">Requisitante:</label>
              <!-- Combobox declarativa (envolve o input existente) -->
              <div data-combo data-role="REQUISITANTE"
                   data-txt="#id_pedido_requisitante"
                   data-hid="#id_pedido_requisitante_id"></div>
              <input type="hidden" name="pedido_requisitante_id" id="id_pedido_requisitante_id" class="input">
              <input type="text" name="pedido_requisitante" maxlength="150" class="input" id="id_pedido_requisitante" autocomplete="off">
            </div>

            <!-- Cliente (pessoa) -->
            <div>
              <label for="id_pedido_cliente">Cliente:</label>
              <div data-combo data-role="CLIENTE"
                   data-txt="#id_pedido_cliente"
                   data-hid="#id_pedido_cliente_id"></div>
              <input type="hidden" name="pedido_cliente_id" id="id_pedido_cliente_id" class="input">
              <input type="text" name="pedido_cliente" maxlength="150" class="input" id="id_pedido_cliente" autocomplete="off">
            </div>

            <!-- Status -->
            <div>
              <label for="id_pedido_status">Status:</label>
              <input type="text" name="pedido_status" maxlength="80" class="input" id="id_pedido_status" autocomplete="off">
            </div>
          </div>

          <div class="mt-3">
            <a class="dynamic-add" data-add="#pedido-extra" data-template="#tpl-pedido-extra">+ inserir campo</a>
            <div id="pedido-extra" class="dynamic-list"></div>
            <template id="tpl-pedido-extra">
              <div class="dynamic-row" data-row>
                <input type="text" name="pedido_extra_key___idx__" placeholder="Nome do campo" class="input">
                <input type="text" name="pedido_extra_val___idx__" placeholder="Valor" class="input">
              </div>
            </template>
          </div>
        </section>

        <!-- OS -->
        <section class="tab-panel" role="tabpanel" data-tab="os">
          <div class="grid">
            <!-- Estilo (pessoa) -->
            <div>
              <label for="id_os_estilo">Estilo:</label>
              <div class="combo" data-combo data-role="ESTILISTA">
                {{ form.os_estilo_id }}
                {{ form.os_estilo }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
            </div>

            <!-- Arte (pessoa) -->
            <div>
              <label for="id_os_arte">Arte:</label>
              <div class="combo" data-combo data-role="ARTE">
                {{ form.os_arte_id }}
                {{ form.os_arte }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
            </div>

            <!-- Modelagem (pessoa) -->
            <div>
              <label for="id_os_modelagem">Modelagem:</label>
              <div class="combo" data-combo data-role="MODELAGEM">
                {{ form.os_modelagem_id }}
                {{ form.os_modelagem }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
            </div>

            <!-- Pilotagem (pessoa) -->
            <div>
              <label for="id_os_pilotagem">Pilotagem:</label>
              <div class="combo" data-combo data-role="PILOTAGEM">
                {{ form.os_pilotagem_id }}
                {{ form.os_pilotagem }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
            </div>

            <!-- Encaixe (pessoa) -->
            <div>
              <label for="id_os_encaixe">Encaixe:</label>
              <div class="combo" data-combo data-role="ENCAIXE">
                {{ form.os_encaixe_id }}
                {{ form.os_encaixe }}
                <button type="button" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false"></button>
              </div>
            </div>
          </div>
        </section>

        <!-- BLING -->
        <section class="tab-panel" role="tabpanel" data-tab="bling" hidden>
          <div class="alert info">EAN-13 em tempo real via <b>Referência</b> + <b>Base</b> + códigos gerados pelos chips da Grade.</div>
          <div class="grid mb-4">
            <div>
              <label class="label" for="ean-ref">Referência (4 dígitos)</label>
              <input id="ean-ref" type="text" maxlength="4" class="input" placeholder="0000" autocomplete="off">
            </div>
            <div>
              <label class="label" for="ean-base">Base (4 dígitos)</label>
              <input id="ean-base" type="text" maxlength="4" class="input" placeholder="0000" autocomplete="off">
            </div>
          </div>

          <div class="grid">
            <div>{{ form.external_id.label_tag }} {{ form.external_id }}</div>
            <div>{{ form.sku.label_tag }} {{ form.sku }}</div>
            <div>{{ form.name.label_tag }} {{ form.name }}</div>

            <div>{{ form.origin.label_tag }} {{ form.origin }}</div>
            <div>{{ form.status.label_tag }} {{ form.status }}</div>
            <div>{{ form.is_active.label_tag }} {{ form.is_active }}</div>

            <div>{{ form.price.label_tag }} {{ form.price }}</div>
            <div>{{ form.cost_price.label_tag }} {{ form.cost_price }}</div>
            <div>{{ form.purchase_price.label_tag }} {{ form.purchase_price }}</div>
            <div>{{ form.stock_qty.label_tag }} {{ form.stock_qty }}</div>

            <div>{{ form.ncm.label_tag }} {{ form.ncm }}</div>
            <div>{{ form.cest.label_tag }} {{ form.cest }}</div>
            <div>{{ form.ipi_fixed.label_tag }} {{ form.ipi_fixed }}</div>
            <div>{{ form.icms_st_base_retencao.label_tag }} {{ form.icms_st_base_retencao }}</div>
            <div>{{ form.icms_st_valor_retencao.label_tag }} {{ form.icms_st_valor_retencao }}</div>
            <div>{{ form.icms_proprio_substituto.label_tag }} {{ form.icms_proprio_substituto }}</div>
            <div>{{ form.gtin.label_tag }} {{ form.gtin }}</div>
            <div>{{ form.fci_number.label_tag }} {{ form.fci_number }}</div>
            <div>{{ form.clone_from_parent.label_tag }} {{ form.clone_from_parent }}</div>
            <div>{{ form.free_shipping.label_tag }} {{ form.free_shipping }}</div>

            <div>{{ form.width_cm.label_tag }} {{ form.width_cm }}</div>
            <div>{{ form.height_cm.label_tag }} {{ form.height_cm }}</div>
            <div>{{ form.length_cm.label_tag }} {{ form.length_cm }}</div>
            <div>{{ form.weight_net.label_tag }} {{ form.weight_net }}</div>
            <div>{{ form.weight_gross.label_tag }} {{ form.weight_gross }}</div>

            <div>{{ form.product_category.label_tag }} {{ form.product_category }}</div>
            <div>{{ form.department.label_tag }} {{ form.department }}</div>
            <div>{{ form.brand.label_tag }} {{ form.brand }}</div>
            <div>{{ form.unit_of_measure.label_tag }} {{ form.unit_of_measure }}</div>

            {# mantém bling_extra como TextArea oculto p/ legado #}
            <div style="display:none">{{ form.bling_extra }}</div>
          </div>

          <div class="mt-3">
            <a class="dynamic-add" data-add="#bling-extra" data-template="#tpl-bling-extra">+ inserir campo</a>
            <div id="bling-extra" class="dynamic-list"></div>
            <template id="tpl-bling-extra">
              <div class="dynamic-row" data-row>
                <input type="text" name="bling_extra_key___idx__" placeholder="Nome do campo" class="input">
                <input type="text" name="bling_extra_val___idx__" placeholder="Valor" class="input">
              </div>
            </template>
          </div>
        </section>

        <!-- MANUFATURA -->
        <section class="tab-panel" role="tabpanel" data-tab="manufatura">
          <div class="grid">
            <!-- Cada campo abaixo vira combobox com busca (texto + hidden id).
                 Mantém o input do form (texto), adiciona um hidden *_id e o wrapper data-combo+data-role.
                 A view pode consumir os *_id no POST se desejar. -->

            <div>
              <label for="id_m_corte">Corte:</label>
              <div data-combo data-role="CORTE"
                   data-txt="#id_m_corte"
                   data-hid="#id_m_corte_id"></div>
              <input type="hidden" name="m_corte_id" id="id_m_corte_id" class="input">
              {{ form.m_corte }}
            </div>

            <div>
              <label for="id_m_costura">Costura:</label>
              <div data-combo data-role="COSTURA"
                   data-txt="#id_m_costura"
                   data-hid="#id_m_costura_id"></div>
              <input type="hidden" name="m_costura_id" id="id_m_costura_id" class="input">
              {{ form.m_costura }}
            </div>

            <div>
              <label for="id_m_estamparia">Estamparia:</label>
              <div data-combo data-role="ESTAMPARIA"
                   data-txt="#id_m_estamparia"
                   data-hid="#id_m_estamparia_id"></div>
              <input type="hidden" name="m_estamparia_id" id="id_m_estamparia_id" class="input">
              {{ form.m_estamparia }}
            </div>

            <div>
              <label for="id_m_bordado">Bordado:</label>
              <div data-combo data-role="BORDADO"
                   data-txt="#id_m_bordado"
                   data-hid="#id_m_bordado_id"></div>
              <input type="hidden" name="m_bordado_id" id="id_m_bordado_id" class="input">
              {{ form.m_bordado }}
            </div>

            <div>
              <label for="id_m_lavanderia">Lavanderia:</label>
              <div data-combo data-role="LAVANDERIA"
                   data-txt="#id_m_lavanderia"
                   data-hid="#id_m_lavanderia_id"></div>
              <input type="hidden" name="m_lavanderia_id" id="id_m_lavanderia_id" class="input">
              {{ form.m_lavanderia }}
            </div>

            <div>
              <label for="id_m_acabamento">Acabamento:</label>
              <div data-combo data-role="ACABAMENTO"
                   data-txt="#id_m_acabamento"
                   data-hid="#id_m_acabamento_id"></div>
              <input type="hidden" name="m_acabamento_id" id="id_m_acabamento_id" class="input">
              {{ form.m_acabamento }}
            </div>
          </div>

          <div class="mt-3">
            <a class="dynamic-add" data-add="#manuf-extra" data-template="#tpl-manuf-extra">+ inserir campo</a>
            <div id="manuf-extra" class="dynamic-list"></div>
            <template id="tpl-manuf-extra">
              <div class="dynamic-row" data-row>
                <input type="text" name="manuf_extra_key___idx__" placeholder="Nome do campo" class="input">
                <input type="text" name="manuf_extra_val___idx__" placeholder="Valor" class="input">
              </div>
            </template>
          </div>
        </section>

        <!-- MATERIAL -->
        <section class="tab-panel" role="tabpanel" data-tab="material" hidden>
          <div class="grid">
            <div>{{ form.os_estilo.label_tag }} {{ form.os_estilo }}</div>
            <div>{{ form.os_arte.label_tag }} {{ form.os_arte }}</div>
            <div>{{ form.os_modelagem.label_tag }} {{ form.os_modelagem }}</div>
            <div>{{ form.os_pilotagem.label_tag }} {{ form.os_pilotagem }}</div>
            <div>{{ form.os_encaixe.label_tag }} {{ form.os_encaixe }}</div>
          </div>
        </section>

        <!-- GRADE -->
        <section class="tab-panel" role="tabpanel" data-tab="grade" hidden>
          <div class="alert info" role="note">
            Adicione variações e defina se cada atributo será <b>linha</b> ou <b>coluna</b>. Use TAB/ENTER/vírgula para criar mini-chips.
          </div>
          {% include "catalog/_grades_variations.html" %}
        </section>

        <!-- AVIAMENTOS OFICINA -->
        <section class="tab-panel" role="tabpanel" data-tab="av-oficina" hidden>
          <div class="grid">
            <div class="col-span-2">{{ form.av_oficina_linha_1.label_tag }} {{ form.av_oficina_linha_1 }}</div>
          </div>
          <div class="mt-3">
            <a class="dynamic-add" data-add="#av-oficina-list" data-template="#tpl-av-oficina-row">+ inserir campo</a>
            <div id="av-oficina-list" class="dynamic-list"></div>
            <template id="tpl-av-oficina-row">
              <div class="dynamic-row" data-row>
                <input type="text" name="av_oficina_item___idx__" placeholder="Item (ex.: Linha 120 Tex)" class="input">
                <input type="text" name="av_oficina_qtd___idx__" placeholder="Qtd/Obs" class="input">
              </div>
            </template>
          </div>
        </section>

        <!-- AVIAMENTOS ACABAMENTO -->
        <section class="tab-panel" role="tabpanel" data-tab="av-acab" hidden>
          <div class="grid">
            <div>{{ form.avacab_sacola.label_tag }} {{ form.avacab_sacola }}</div>
            <div>{{ form.avacab_tag.label_tag }} {{ form.avacab_tag }}</div>
          </div>
        </section>
      </div>

      <div class="form-actions">
        <button class="btn" type="submit">Salvar</button>
        <a class="btn secondary" href="{% url 'catalog:produto_list' %}">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<link rel="stylesheet" href="{% static 'crontex/css/catalog.css' %}">
<link rel="stylesheet" href="{% static 'crontex/css/grades_variations.css' %}">
<script src="{% static 'crontex/js/produto_form_full.js' %}"></script>
{# Conector de pessoas (front) — usa /people/api/search e /people/api/get #}
<script src="{% static 'crontex/js/people_optionlist.js' %}?v=3"></script>
{% endblock %}
